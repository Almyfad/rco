CREATE TABLE IF NOT EXISTS `reformatintra`.`historique_modifications` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `nom_table` VARCHAR(255) NOT NULL,
    `id_enregistrement_modifie` VARCHAR(255) NOT NULL COMMENT 'ID de la ligne modifi√©e dans la table source',
    `type_operation` ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,
    `date_modification` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `utilisateur_modificateur` VARCHAR(255) DEFAULT NULL,
    `anciennes_valeurs` JSON DEFAULT NULL,
    `nouvelles_valeurs` JSON DEFAULT NULL,
    `modifs_valeurs` JSON DEFAULT NULL
) -- #############################################################################
;

;

DELIMITER ##
CREATE
OR REPLACE TRIGGER `trg_listing_modifications`
AFTER
UPDATE
    ON `reformatintra`.`listing` FOR EACH ROW 
INSERT INTO
    `reformatintra`.`historique_modifications` (
        `statut`,
        `nom_table`,
        `id_enregistrement_modifie`,
        `type_operation`,
        `utilisateur_modificateur`,
        `anciennes_valeurs`,
        `nouvelles_valeurs`
    )
VALUES
    (
        CASE SUBSTRING_INDEX(USER(), '@', 1) WHEN 'sync' THEN 'OK' else 'En attente' END,
        'listing',
        NEW.listing_id,
        'UPDATE',
        SUBSTRING_INDEX(USER(), '@', 1),
        JSON_OBJECT(
            'listing_id',
            OLD.listing_id,
            'listing_last_modif',
            OLD.listing_last_modif,
            'listing_last_modifiant',
            OLD.listing_last_modifiant,
            'listing_nom',
            OLD.listing_nom,
            'listing_nom_jeune_fille',
            OLD.listing_nom_jeune_fille,
            'listing_prenom',
            OLD.listing_prenom,
            'listing_password',
            OLD.listing_password,
            'listing_pwd',
            OLD.listing_pwd,
            'listing_civilite',
            OLD.listing_civilite,
            'listing_adresse_1',
            OLD.listing_adresse_1,
            'listing_adresse_2',
            OLD.listing_adresse_2,
            'listing_cp',
            OLD.listing_cp,
            'listing_ville',
            OLD.listing_ville,
            'listing_telephone',
            OLD.listing_telephone,
            'listing_fax',
            OLD.listing_fax,
            'listing_portable',
            OLD.listing_portable,
            'listing_email',
            OLD.listing_email,
            'listing_email_statut',
            OLD.listing_email_statut,
            'listing_profession',
            OLD.listing_profession,
            'listing_connaissances',
            OLD.listing_connaissances,
            'listing_date_naissance',
            OLD.listing_date_naissance,
            'listing_lieu_naissance',
            OLD.listing_lieu_naissance,
            'listing_etat_civil',
            OLD.listing_etat_civil,
            'listing_nombre_enfants',
            OLD.listing_nombre_enfants,
            'listing_nationalite',
            OLD.listing_nationalite,
            'listing_remarques',
            OLD.listing_remarques,
            'listing_pays',
            OLD.listing_pays,
            'listing_centre',
            OLD.listing_centre,
            'listing_centre_bis',
            OLD.listing_centre_bis,
            'listing_date_1er_contact',
            OLD.listing_date_1er_contact,
            'listing_date_societaire',
            OLD.listing_date_societaire,
            'listing_date_1er_aspect',
            OLD.listing_date_1er_aspect,
            'listing_date_2eme_aspect',
            OLD.listing_date_2eme_aspect,
            'listing_date_preparatoire',
            OLD.listing_date_preparatoire,
            'listing_date_probatoire',
            OLD.listing_date_probatoire,
            'listing_date_conffessionnelle',
            OLD.listing_date_conffessionnelle,
            'listing_date_ecs',
            OLD.listing_date_ecs,
            'listing_date_eccls',
            OLD.listing_date_eccls,
            'listing_date_graal',
            OLD.listing_date_graal,
            'listing_date_tete_or',
            OLD.listing_date_tete_or,
            'listing_date_6eme_aspect',
            OLD.listing_date_6eme_aspect,
            'listing_installation_note',
            OLD.listing_installation_note,
            'listing_date_bapteme',
            OLD.listing_date_bapteme,
            'listing_date_mariage_benediction',
            OLD.listing_date_mariage_benediction,
            'listing_date_mariage_sacrement',
            OLD.listing_date_mariage_sacrement,
            'listing_date_codicille',
            OLD.listing_date_codicille,
            'listing_date_demission',
            OLD.listing_date_demission,
            'listing_date_deces',
            OLD.listing_date_deces,
            'listing_bapteme',
            OLD.listing_bapteme,
            'listing_bapteme_numero',
            OLD.listing_bapteme_numero,
            'listing_mariage_benediction',
            OLD.listing_mariage_benediction,
            'listing_mariage_sacrement',
            OLD.listing_mariage_sacrement,
            'listing_codicille',
            OLD.listing_codicille,
            'listing_codicille_lieu',
            OLD.listing_codicille_lieu,
            'listing_categorie',
            OLD.listing_categorie,
            'listing_cat_juridique',
            OLD.listing_cat_juridique,
            'listing_statut',
            OLD.listing_statut,
            'listing_valid_statut',
            OLD.listing_valid_statut,
            'listing_chantier',
            OLD.listing_chantier,
            'listing_famille',
            OLD.listing_famille,
            'listing_fiche_remplie',
            OLD.listing_fiche_remplie,
            'listing_cr_r',
            OLD.listing_cr_r,
            'listing_cr_dispense',
            OLD.listing_cr_dispense,
            'listing_cr',
            OLD.listing_cr,
            'listing_intranet_id',
            OLD.listing_intranet_id,
            'listing_code_idu',
            OLD.listing_code_idu,
            'listing_intranet_email',
            OLD.listing_intranet_email,
            'listing_mailchimp_id',
            OLD.listing_mailchimp_id,
            'listing_numero_eleve',
            OLD.listing_numero_eleve,
            'listing_code',
            OLD.listing_code,
            'listing_rgdp',
            OLD.listing_rgdp
        ),
        JSON_OBJECT(
            'listing_id',
            NEW.listing_id,
            'listing_last_modif',
            NEW.listing_last_modif,
            'listing_last_modifiant',
            NEW.listing_last_modifiant,
            'listing_nom',
            NEW.listing_nom,
            'listing_nom_jeune_fille',
            NEW.listing_nom_jeune_fille,
            'listing_prenom',
            NEW.listing_prenom,
            'listing_password',
            NEW.listing_password,
            'listing_pwd',
            NEW.listing_pwd,
            'listing_civilite',
            NEW.listing_civilite,
            'listing_adresse_1',
            NEW.listing_adresse_1,
            'listing_adresse_2',
            NEW.listing_adresse_2,
            'listing_cp',
            NEW.listing_cp,
            'listing_ville',
            NEW.listing_ville,
            'listing_telephone',
            NEW.listing_telephone,
            'listing_fax',
            NEW.listing_fax,
            'listing_portable',
            NEW.listing_portable,
            'listing_email',
            NEW.listing_email,
            'listing_email_statut',
            NEW.listing_email_statut,
            'listing_profession',
            NEW.listing_profession,
            'listing_connaissances',
            NEW.listing_connaissances,
            'listing_date_naissance',
            NEW.listing_date_naissance,
            'listing_lieu_naissance',
            NEW.listing_lieu_naissance,
            'listing_etat_civil',
            NEW.listing_etat_civil,
            'listing_nombre_enfants',
            NEW.listing_nombre_enfants,
            'listing_nationalite',
            NEW.listing_nationalite,
            'listing_remarques',
            NEW.listing_remarques,
            'listing_pays',
            NEW.listing_pays,
            'listing_centre',
            NEW.listing_centre,
            'listing_centre_bis',
            NEW.listing_centre_bis,
            'listing_date_1er_contact',
            NEW.listing_date_1er_contact,
            'listing_date_societaire',
            NEW.listing_date_societaire,
            'listing_date_1er_aspect',
            NEW.listing_date_1er_aspect,
            'listing_date_2eme_aspect',
            NEW.listing_date_2eme_aspect,
            'listing_date_preparatoire',
            NEW.listing_date_preparatoire,
            'listing_date_probatoire',
            NEW.listing_date_probatoire,
            'listing_date_conffessionnelle',
            NEW.listing_date_conffessionnelle,
            'listing_date_ecs',
            NEW.listing_date_ecs,
            'listing_date_eccls',
            NEW.listing_date_eccls,
            'listing_date_graal',
            NEW.listing_date_graal,
            'listing_date_tete_or',
            NEW.listing_date_tete_or,
            'listing_date_6eme_aspect',
            NEW.listing_date_6eme_aspect,
            'listing_installation_note',
            NEW.listing_installation_note,
            'listing_date_bapteme',
            NEW.listing_date_bapteme,
            'listing_date_mariage_benediction',
            NEW.listing_date_mariage_benediction,
            'listing_date_mariage_sacrement',
            NEW.listing_date_mariage_sacrement,
            'listing_date_codicille',
            NEW.listing_date_codicille,
            'listing_date_demission',
            NEW.listing_date_demission,
            'listing_date_deces',
            NEW.listing_date_deces,
            'listing_bapteme',
            NEW.listing_bapteme,
            'listing_bapteme_numero',
            NEW.listing_bapteme_numero,
            'listing_mariage_benediction',
            NEW.listing_mariage_benediction,
            'listing_mariage_sacrement',
            NEW.listing_mariage_sacrement,
            'listing_codicille',
            NEW.listing_codicille,
            'listing_codicille_lieu',
            NEW.listing_codicille_lieu,
            'listing_categorie',
            NEW.listing_categorie,
            'listing_cat_juridique',
            NEW.listing_cat_juridique,
            'listing_statut',
            NEW.listing_statut,
            'listing_valid_statut',
            NEW.listing_valid_statut,
            'listing_chantier',
            NEW.listing_chantier,
            'listing_famille',
            NEW.listing_famille,
            'listing_fiche_remplie',
            NEW.listing_fiche_remplie,
            'listing_cr_r',
            NEW.listing_cr_r,
            'listing_cr_dispense',
            NEW.listing_cr_dispense,
            'listing_cr',
            NEW.listing_cr,
            'listing_intranet_id',
            NEW.listing_intranet_id,
            'listing_code_idu',
            NEW.listing_code_idu,
            'listing_intranet_email',
            NEW.listing_intranet_email,
            'listing_mailchimp_id',
            NEW.listing_mailchimp_id,
            'listing_numero_eleve',
            NEW.listing_numero_eleve,
            'listing_code',
            NEW.listing_code,
            'listing_rgdp',
            NEW.listing_rgdp
        )
    );

END ##